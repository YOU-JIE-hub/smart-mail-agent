=== GIT ===
share/source-dump-20250817T052737
70d9511ad chore: source bundle for review (temporary)

=== FILES ===
✓ src/smart_mail_agent/spam/orchestrator_offline.py
✓ src/run_action_handler.py
✓ .github/workflows/ci.yml
✓ pyproject.toml
✓ .pre-commit-config.yaml

=== orchestrator_offline.py checks ===
- ham 覆寫為 0.0：
324:    label, score, source, err = _call_model_robust(model, email, model_threshold)
   324	    label, score, source, err = _call_model_robust(model, email, model_threshold)
   325	
   326	    # ham 標籤一律視為非垃圾：覆寫 score 為 0.0
   327	
   328	    if label == "ham":
   329	
   330	        score = 0.0
   331	
   332	    is_spam = score >= model_threshold
   333	    is_borderline = bool(model is not None and score == model_threshold)
   334	    action = "review" if (is_spam and is_borderline) else ("drop" if is_spam else "route_to_inbox")
   335	
   336	    ns = SimpleNamespace(is_spam=is_spam, is_borderline=is_borderline, source=source, action=action)
   337	    if source == "fallback" and err:
   338	        ns.extra = {"model_error": err}

- 只以分數判定 is_spam：
332:    is_spam = score >= model_threshold

- link_ratio reason：
193:            reasons.append(f"rule:link_ratio>={d}")
203:            reasons.append(f"rule:link_ratio>={r}")
266:            reasons.append(f"rule:link_ratio>={d}")
276:            reasons.append(f"rule:link_ratio>={r}")

- NFKC 與 keyword 規則：
156:                x = unicodedata.normalize("NFKC", x or "")
233:                x = _ud.normalize("NFKC", x or "")
169:                    "reasons": ["rule:keyword"],
294:                "reasons": ["rule:keyword"],

=== run_action_handler.py checks ===
- 附件風險代碼：
91:                risks.append("attach:double_ext")
96:            risks.append("attach:long_name")
101:            risks.append("attach:mime_mismatch")
- require_review 時自動 CC support：
202:        if "support@company.example" not in cc:
203:            cc.append("support@company.example")
- 主旨自動前綴 [自動回覆]：
44:def _subject_with_prefix(subj: str) -> str:

=== CI / Tooling ===
41:          pytest -q --disable-warnings --cov=src --cov-report=xml --cov-report=term-missing
2:line-length = 100
14:line-length = 100
12:[tool.ruff]
repos:
  - repo: https://github.com/psf/black
    rev: 24.3.0
    hooks: [{ id: black }]
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks: [{ id: isort }]
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.5.7
    hooks: [{ id: ruff }]

=== Lint ===
ruff 0.12.9
black, 25.1.0 (compiled: yes)
Python (CPython) 3.10.12

                 _                 _
                (_) ___  ___  _ __| |_
                | |/ _/ / _ \/ '__  _/
                | |\__ \/\_\/| |  | |_
                |_|\___/\___/\_/   \_/

      isort your imports, so you don't have to.

                    VERSION 6.0.1


-> ruff check
All checks passed!

-> black --check

-> isort --check-only

=== Pytest (summary) ===

==================================== ERRORS ====================================
_______ ERROR collecting tests/contracts/test_action_result_contracts.py _______
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/contracts/test_action_result_contracts.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/contracts/test_action_result_contracts.py:6: in <module>
    from src.sma_types import ActionResult, AttachmentMeta
E   ModuleNotFoundError: No module named 'src'
_______________ ERROR collecting tests/e2e/test_spam_pipeline.py _______________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/e2e/test_spam_pipeline.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/e2e/test_spam_pipeline.py:3: in <module>
    from src.spam.pipeline import analyze
E   ModuleNotFoundError: No module named 'src'
_________ ERROR collecting tests/integration/test_online_send_paths.py _________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/integration/test_online_send_paths.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/integration/test_online_send_paths.py:9: in <module>
    oc = importlib.import_module("scripts.online_check")
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
E   ModuleNotFoundError: No module named 'scripts'
________ ERROR collecting tests/portfolio/test_email_processor_utils.py ________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/portfolio/test_email_processor_utils.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/portfolio/test_email_processor_utils.py:5: in <module>
    from src.email_processor import extract_fields, write_classification_result
E   ModuleNotFoundError: No module named 'src'
____ ERROR collecting tests/portfolio/test_inference_classifier_fallback.py ____
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/portfolio/test_inference_classifier_fallback.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/portfolio/test_inference_classifier_fallback.py:1: in <module>
    import src.inference_classifier as ic
E   ModuleNotFoundError: No module named 'src'
_____________ ERROR collecting tests/portfolio/test_log_writer.py ______________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/portfolio/test_log_writer.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/portfolio/test_log_writer.py:4: in <module>
    from src.log_writer import log_to_db
E   ModuleNotFoundError: No module named 'src'
___________ ERROR collecting tests/portfolio/test_patches_router.py ____________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/portfolio/test_patches_router.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/portfolio/test_patches_router.py:5: in <module>
    import src.patches.handle_router_patch as hr
E   ModuleNotFoundError: No module named 'src'
______________ ERROR collecting tests/portfolio/test_pdf_safe.py _______________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/portfolio/test_pdf_safe.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/portfolio/test_pdf_safe.py:4: in <module>
    import src.smart_mail_agent.utils.pdf_safe as ps
E   ModuleNotFoundError: No module named 'src'
_________ ERROR collecting tests/portfolio/test_spam_rules_scoring.py __________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/portfolio/test_spam_rules_scoring.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/portfolio/test_spam_rules_scoring.py:6: in <module>
    import src.smart_mail_agent.spam.rules as rules
E   ModuleNotFoundError: No module named 'src'
___________ ERROR collecting tests/portfolio/test_support_ticket.py ____________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/portfolio/test_support_ticket.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/portfolio/test_support_ticket.py:6: in <module>
    from src import support_ticket as st
E   ModuleNotFoundError: No module named 'src'
________________ ERROR collecting tests/unit/test_contracts.py _________________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/unit/test_contracts.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/unit/test_contracts.py:4: in <module>
    from src.sma_types import normalize_request, normalize_result
E   ModuleNotFoundError: No module named 'src'
______________ ERROR collecting tests/unit/test_policy_engine.py _______________
ImportError while importing test module '/home/youjie/projects/smart-mail-agent/tests/unit/test_policy_engine.py'.
Hint: make sure your test modules/packages have valid Python names.
Traceback:
/usr/lib/python3.10/importlib/__init__.py:126: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
tests/unit/test_policy_engine.py:4: in <module>
    from src.policy_engine import apply_policies, apply_policy
E   ModuleNotFoundError: No module named 'src'
=============================== warnings summary ===============================
<frozen importlib._bootstrap>:283
  <frozen importlib._bootstrap>:283: DeprecationWarning: the load_module() method is deprecated and slated for removal in Python 3.12; use exec_module() instead

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
ERROR tests/contracts/test_action_result_contracts.py
ERROR tests/e2e/test_spam_pipeline.py
ERROR tests/integration/test_online_send_paths.py
ERROR tests/portfolio/test_email_processor_utils.py
ERROR tests/portfolio/test_inference_classifier_fallback.py
ERROR tests/portfolio/test_log_writer.py
ERROR tests/portfolio/test_patches_router.py
ERROR tests/portfolio/test_pdf_safe.py
ERROR tests/portfolio/test_spam_rules_scoring.py
ERROR tests/portfolio/test_support_ticket.py
ERROR tests/unit/test_contracts.py
ERROR tests/unit/test_policy_engine.py
!!!!!!!!!!!!!!!!!!! Interrupted: 12 errors during collection !!!!!!!!!!!!!!!!!!!
1 warning, 12 errors in 0.31s
