#!/usr/bin/env bash
set -Eeuo pipefail
ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT"

# venv：一定是先進專案再開環境
if [[ ! -f .venv/bin/activate ]]; then
  python3 -m venv .venv
fi
. .venv/bin/activate
if [[ -f requirements.txt && ! -f .venv/.deps_installed ]]; then
  python -m pip -q install -U pip
  pip -q install -r requirements.txt || true
  touch .venv/.deps_installed
fi

: "${SMA_LOG_DIR:=logs}"
mkdir -p "$SMA_LOG_DIR" data/output

if [[ $# -eq 0 ]]; then
  [[ -f data/output/in_sales.json ]] || cat > data/output/in_sales.json <<'JSON'
{"subject":"詢價與合作","from":"alice@partner.co","body":"想了解報價與合作方案。"}
JSON
  [[ -f data/output/in_complaint.json ]] || cat > data/output/in_complaint.json <<'JSON'
{"subject":"嚴重投訴","from":"bob@example.com","body":"我的訂單延誤，請儘速協助。"}
JSON
  PYTHONPATH=src python -m src.run_action_handler --input data/output/in_sales.json --output data/output/out_sales.json --dry-run
  PYTHONPATH=src python -m src.run_action_handler --input data/output/in_complaint.json --output data/output/out_complaint.json --dry-run
else
  PYTHONPATH=src python -m src.run_action_handler "$@"
fi
