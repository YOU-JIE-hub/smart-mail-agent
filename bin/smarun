#!/usr/bin/env bash
set -Eeuo pipefail
trap 'ec=$?; echo "âŒ smarun failed at line $LINENO (exit $ec)"; exit $ec' ERR

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")"/.. && pwd)"
cd "$ROOT"

# å…ˆé€²å°ˆæ¡ˆï¼Œå†é–‹ venv
if [[ -f .venv/bin/activate ]]; then
  . .venv/bin/activate
elif [[ -x bin/smaenv ]]; then
  bin/smaenv
else
  python3 -m venv .venv
  . .venv/bin/activate
  python -m pip -q install -U pip
  [[ -f requirements.txt ]] && pip -q install -r requirements.txt || true
fi

export PYTHONFAULTHANDLER=1
export PYTHONWARNINGS="${PYTHONWARNINGS:-default}"
export SMA_LOG_DIR="${SMA_LOG_DIR:-$ROOT/logs}"
mkdir -p "$SMA_LOG_DIR" data/output

# åŒ¯å…¥æª¢æŸ¥ï¼ˆä¸å†ç”¨ heredocï¼‰
if ! PYTHONPATH=src python -c "import importlib; importlib.import_module('src.run_action_handler')" >/dev/null 2>&1; then
  echo "âŒ ç„¡æ³• import src.run_action_handlerï¼ˆæª¢æŸ¥ PYTHONPATH=src èˆ‡ç¨‹å¼æª”ï¼‰" >&2
  exit 3
fi

# æ²’åƒæ•¸å°±è‡ªå‹•è·‘ sampleï¼ˆ--dry-runï¼‰
if [[ $# -eq 0 ]]; then
  [[ -f data/output/in_sales.json ]] || cat > data/output/in_sales.json <<'JSON'
{"subject":"è©¢åƒ¹èˆ‡åˆä½œ","from":"alice@partner.co","body":"æƒ³äº†è§£å ±åƒ¹èˆ‡åˆä½œæ–¹æ¡ˆã€‚"}
JSON
  set -- --input data/output/in_sales.json --output data/output/out_sales.json --dry-run
fi

PYTHONPATH=src python -X dev -m src.run_action_handler "$@"

# æ‘˜è¦è¼¸å‡º & log å°¾å·´
out=""; prev=""
for a in "$@"; do [[ "$prev" == "--output" ]] && out="$a"; prev="$a"; done
if [[ -n "$out" && -f "$out" ]]; then
  echo "âœ… è¼¸å‡ºï¼š$out"
  PYTHONPATH=src python - "$out" <<'PY' || true
import json, sys
d = json.load(open(sys.argv[1], "r", encoding="utf-8"))
print("logged_path =", d.get("logged_path"))
print("warnings    =", d.get("warnings"))
PY
fi
LOG="$SMA_LOG_DIR/sma-$(date +%Y%m%d).jsonl"
[[ -f "$LOG" ]] && { echo "ğŸ“ Log tail:"; tail -n 5 "$LOG" || true; } || echo "âš ï¸ æ²’æœ‰ç•¶æ—¥ JSONLï¼š$LOG"
