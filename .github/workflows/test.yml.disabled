# .github/workflows/test.yml
# Smart-Mail-Agent 專案專用：CI 自動執行單元測試與模組驗證

name: Smart-Mail-Agent CI Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: 下載專案程式碼
      uses: actions/checkout@v3

    - name: 安裝 Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: 建立虛擬環境與安裝相依套件
      run: |
        python -m venv .venv
        source .venv/bin/activate
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: 建立必要資料目錄與測試資料
      run: |
        mkdir -p data/testdata
        echo '{"subject": "測試分類", "body": "您好，請問可以報價嗎？", "sender": "demo@example.com"}' > data/testdata/test_mail.json

    - name: 執行分類模型測試
      run: |
        source .venv/bin/activate
        python src/inference_classifier.py \
          --input data/testdata/test_mail.json \
          --output tmp/test_output.json \
          --model model/roberta-zh-checkpoint

    - name: 執行垃圾信過濾測試
      run: |
        source .venv/bin/activate
        python run_orchestrator.py --input data/testdata/test_mail.json

    - name: 執行分類處理模組測試（Action Handler）
      run: |
        source .venv/bin/activate
        python src/action_handler.py --json tmp/test_output.json

    - name: 執行主流程測試（Email Processor）
      run: |
        source .venv/bin/activate
        python src/email_processor.py --input data/testdata/test_mail.json

    - name: 執行單元測試（Pytest）
      run: |
        source .venv/bin/activate
        pytest tests/ --maxfail=2 --disable-warnings

    - name: 上傳測試快取（可選）
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-cache
        path: .pytest_cache/
